<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>Joystick remote control (background movable)</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 2 px;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            background-color: #ffffff;
            overflow: hidden;
        }

        #characterImage {
            position: absolute;
            top: calc(100% - 450px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5%;
            height: auto;
        }

        #background {
            position: fixed;
            display: flex;
            top: 30%;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: auto;
        }

        #background img {
            position: absolute;
            top: 0;
            left: 0;
            width: auto;
            height: auto;
            min-width: 100%;
            min-height: 100%;
        }
    </style>
</head>

<body>
    <div id="background">
        <img src="park.jpg">
    </div>
    <img id="characterImage" src="cat.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        var socket = io.connect('http://192.168.1.119:3000'); // Replace with your server IP

        var data = {
            xPosition: 0,
            yPosition: 0,
            x: 0,
            y: 0,
            cardinalDirection: "C",
            containerId: ""
        };

        var isDragging = false;
        var lastJoystickData = null;

        function moveCharacterImage(data) {
            var characterImg = document.getElementById('characterImage');
            var backgroundImg = document.getElementById('background').querySelector('img');
            var backgroundLeft = backgroundImg.offsetLeft;
            var backgroundTop = backgroundImg.offsetTop;

            var maxMoveX = 12; // X轴移动的最大速度因子
            var maxMoveY = 12; // Y轴移动的最大速度因子
            var backgroundSpeedFactor = 3; // 背景滚动速度因子，值越小滚动越慢

            var speedX = Math.abs(data.x) / 100 * maxMoveX;
            var speedY = Math.abs(data.y) / 100 * maxMoveY;
            var directionX = data.x >= 0 ? 1 : -1;
            var directionY = data.y >= 0 ? 1 : -1;
            var offsetX = directionX * speedX;
            var offsetY = directionY * speedY;

            var windowWidth = window.innerWidth;
            var windowHeight = window.innerHeight;
            var backgroundOffsetX = parseFloat(backgroundImg.style.left) || 0;
            var backgroundOffsetY = parseFloat(backgroundImg.style.top) || 0;
            var newBackgroundOffsetX = backgroundOffsetX;
            var newBackgroundOffsetY = backgroundOffsetY;
            var backgroundReachedLimitX = false;
            var backgroundReachedLimitY = false;

            // check if image is centered on screen
            var characterCenterThresholdX = windowWidth / 2;
            var characterCenterThresholdY = windowHeight / 2;
            var characterInCenterX = Math.abs(parseFloat(characterImg.offsetLeft) - characterCenterThresholdX) < maxMoveX;


            if (characterCenterThresholdX == windowWidth / 2 && characterInCenterX) {
                // move background
                newBackgroundOffsetX -= offsetX * backgroundSpeedFactor;
                newBackgroundOffsetY -= offsetY * backgroundSpeedFactor;
                var backgroundImgWidth = backgroundImg.clientWidth;
                var currentImgTop = parseFloat(characterImg.offsetTop) || 0;
                var maxScrollX = backgroundImgWidth - windowWidth;
                var newImgTop = currentImgTop - offsetY;

                if (newBackgroundOffsetX < -maxScrollX) {
                    newBackgroundOffsetX = -maxScrollX;
                    backgroundReachedLimitX = true;
                }
                if (newBackgroundOffsetX > 0) {
                    newBackgroundOffsetX = 0;
                    backgroundReachedLimitX = true;
                }

                if (newImgTop < backgroundTop) {
                    newImgTop = backgroundTop;
                }
                if (newImgTop > windowHeight) {
                    newImgTop = windowHeight;

                }
                characterImg.style.left = `${newImgLeft}px`;
                characterImg.style.top = `${newImgTop}px`;

                backgroundImg.style.left = `${newBackgroundOffsetX}px`;

                // 当背景达到边界，图片移动到中间
                if (backgroundReachedLimitX) {
                    console.log(123);
                    var currentImgLeft = parseFloat(characterImg.offsetLeft) || 0;
                    var currentImgTop = parseFloat(characterImg.offsetTop) || 0;
                    var newImgLeft = currentImgLeft + offsetX;
                    var newImgTop = currentImgTop - offsetY;

                    if (newImgLeft < backgroundLeft) {
                        newImgLeft = backgroundLeft;
                    }
                    if (newImgLeft > windowWidth) {
                        newImgLeft = windowWidth;
                    }
                    if (newImgTop < backgroundTop) {
                        newImgTop = backgroundTop;
                    }
                    if (newImgTop > windowHeight) {
                        newImgTop = windowHeight;

                    }

                    characterImg.style.left = `${newImgLeft}px`;
                    characterImg.style.top = `${newImgTop}px`;
                }
            } else {
                // 将图片移动到中间
                var currentImgLeft = parseFloat(characterImg.style.left) || 0;
                var currentImgTop = parseFloat(characterImg.style.top) || 0;
                var newImgLeft = currentImgLeft + offsetX;
                var newImgTop = currentImgTop - offsetY;

                // 限制图片在视窗内移动
                if (newImgLeft < 0) {
                    newImgLeft = 0;
                }
                if (newImgLeft > windowWidth) {
                    newImgLeft = windowWidth;
                }
                if (newImgTop < 0) {
                    newImgTop = 0;
                }
                if (newImgTop > windowHeight) {
                    newImgTop = windowHeight;
                }

                // 当图片回到中间后再移动背景
                if (Math.abs(newImgLeft - characterCenterThresholdX) < maxMoveX && Math.abs(newImgTop - characterCenterThresholdY) < maxMoveY) {
                    newImgLeft = characterCenterThresholdX;
                    newImgTop = characterCenterThresholdY;
                }

                characterImg.style.left = `${newImgLeft}px`;
                characterImg.style.top = `${newImgTop}px`;
            }
        }

        function animationLoop() {
            if (isDragging && lastJoystickData) {
                moveCharacterImage(lastJoystickData);
            }
            requestAnimationFrame(animationLoop);
        }

        // Start the animation loop
        animationLoop();

        // Handle joystick data received from socket
        socket.on('joystickMove', function (data) {
            isDragging = true;
            lastJoystickData = data;
        });

        // Handle mouse release
        document.addEventListener('mouseup', function () {
            isDragging = false;
        });

        // Handle touch end (for touch devices)
        document.addEventListener('touchend', function () {
            isDragging = false;
        });

    </script>
</body>

</html>